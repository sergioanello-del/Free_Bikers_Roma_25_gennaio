<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Bikers Roma - Gita a Sermoneta & Modulo Adesione Public</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        :root {
            --primary: #f59e0b;
            --dark: #0a0a0a;
            --card-bg: rgba(31, 41, 55, 0.7);
        }

        body {
            background-color: var(--dark);
            color: #e5e7eb;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .glass-effect {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .btn-primary {
            background-color: var(--primary);
            color: black;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
        }

        input[type="text"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: white;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
        }

        input[type="text"]:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
        }

        .custom-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        .custom-table th {
            text-align: left;
            padding: 12px;
            color: var(--primary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
        }
        .custom-table td {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
        }
        .custom-table tr td:first-child { border-radius: 8px 0 0 8px; }
        .custom-table tr td:last-child { border-radius: 0 8px 8px 0; }
    </style>
</head>
<body>

    <header class="relative h-[40vh] flex items-center justify-center text-center px-4 overflow-hidden">
        <div class="absolute inset-0 z-0">
            <img src="https://images.unsplash.com/photo-1558981403-c5f91cbba527?auto=format&fit=crop&q=80&w=2000" alt="Biker Hero" class="w-full h-full object-cover opacity-40">
            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-[#0a0a0a]"></div>
        </div>
        <div class="relative z-10" data-aos="fade-up">
            <h1 class="text-4xl md:text-6xl font-black italic mb-2 text-white">FREE BIKERS <span class="text-amber-500">ROMA</span></h1>
            <p class="text-lg text-gray-300 font-light tracking-widest uppercase">Community Public Event</p>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-6 py-8">
        
        <!-- Form Pubblico -->
        <section id="adesione" class="mb-12" data-aos="fade-up">
            <div class="glass-effect p-8 rounded-3xl shadow-2xl">
                <div class="text-center mb-10">
                    <h2 class="text-2xl font-bold">Unisciti alla Gita</h2>
                    <p class="text-gray-400">Modulo aperto a tutti i membri</p>
                </div>

                <form id="registrationForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-amber-500 mb-2">Nome</label>
                            <input type="text" id="firstName" name="firstName" required placeholder="Inserisci Nome">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-amber-500 mb-2">Cognome</label>
                            <input type="text" id="lastName" name="lastName" required placeholder="Inserisci Cognome">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-amber-500 mb-2">Nick Name</label>
                        <input type="text" id="nickName" name="nickName" placeholder="Come ti chiamano nel gruppo?">
                    </div>

                    <div class="flex items-center space-x-4 p-4 glass-effect rounded-xl border-dashed border-amber-500/30 border-2">
                        <label class="font-medium">Vieni con Zavorrina?</label>
                        <div class="flex items-center space-x-6">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="zavorrina" value="Si" class="form-radio text-amber-500 h-5 w-5">
                                <span class="ml-2">Sì</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="zavorrina" value="No" checked class="form-radio text-amber-500 h-5 w-5">
                                <span class="ml-2">No</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full btn-primary py-4 rounded-xl text-lg uppercase tracking-widest">
                        Registra la mia partecipazione
                    </button>
                </form>
                <div id="formFeedback" class="hidden mt-6 p-4 rounded-xl text-center font-bold"></div>
            </div>
        </section>

        <!-- DASHBOARD PUBBLICA -->
        <section id="lista-adesioni" class="mb-20" data-aos="fade-up">
            <div class="glass-effect p-8 rounded-3xl shadow-2xl border-amber-500/40">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white"><i class="fa-solid fa-users text-amber-500 mr-3"></i>Partecipanti Pubblici</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-400 text-sm">Totale:</span>
                        <span id="counter" class="bg-amber-500 text-black px-3 py-1 rounded-full font-bold text-sm">0</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Partecipante</th>
                                <th>Nick</th>
                                <th>Zavorrina</th>
                            </tr>
                        </thead>
                        <tbody id="participantsList">
                            <tr>
                                <td colspan="3" class="text-center text-gray-500 py-10">Connessione al database...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <footer class="py-12 border-t border-amber-500/20 text-center text-gray-500 text-sm">
        <p>&copy; 2026 Free Bikers Roma. Modulo Pubblico Eventi.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'free-bikers-event';

        let currentUser = null;

        // Auth initialization
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loadPublicList();
            }
        });

        // Caricamento lista pubblica
        function loadPublicList() {
            if (!currentUser) return;

            // Utilizzo del percorso pubblico obbligatorio
            const registrationsRef = collection(db, 'artifacts', appId, 'public', 'data', 'adesioni');
            
            onSnapshot(registrationsRef, (snapshot) => {
                const listElement = document.getElementById('participantsList');
                const counter = document.getElementById('counter');
                
                let html = '';
                let count = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    count++;
                    html += `
                        <tr class="hover:bg-amber-500/5 transition-colors">
                            <td class="font-medium text-white">${data.nome} ${data.cognome}</td>
                            <td class="text-amber-500">${data.nickname || '-'}</td>
                            <td>
                                <span class="px-2 py-1 rounded text-xs ${data.zavorrina === 'Si' ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">
                                    ${data.zavorrina === 'Si' ? 'SI' : 'NO'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                if (count === 0) {
                    html = '<tr><td colspan="3" class="text-center text-gray-500 py-10">Ancora nessuno? Sii il primo ad iscriverti!</td></tr>';
                }

                listElement.innerHTML = html;
                counter.textContent = count;
            }, (error) => {
                console.error("Snapshot error:", error);
            });
        }

        const form = document.getElementById('registrationForm');
        const feedback = document.getElementById('formFeedback');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            submitBtn.disabled = true;
            submitBtn.textContent = "Registrazione in corso...";

            const formData = {
                nome: document.getElementById('firstName').value.trim(),
                cognome: document.getElementById('lastName').value.trim(),
                nickname: document.getElementById('nickName').value.trim(),
                zavorrina: document.querySelector('input[name="zavorrina"]:checked').value,
                timestamp: serverTimestamp(),
                userId: currentUser.uid
            };

            try {
                const registrationsRef = collection(db, 'artifacts', appId, 'public', 'data', 'adesioni');
                await addDoc(registrationsRef, formData);
                
                showMessage("Grande! Ti sei registrato correttamente.", "bg-green-500/20 text-green-500");
                form.reset();
            } catch (error) {
                console.error("Submit error:", error);
                showMessage("Ops! Qualcosa è andato storto. Riprova.", "bg-red-500/20 text-red-500");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Registra la mia partecipazione";
            }
        });

        function showMessage(msg, classes) {
            feedback.textContent = msg;
            feedback.className = `mt-6 p-4 rounded-xl text-center font-bold ${classes}`;
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 5000);
        }

        AOS.init({ duration: 800, once: true });
    </script>
</body>
</html>